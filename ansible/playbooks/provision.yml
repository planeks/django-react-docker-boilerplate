---
# ============================================================================
# Server Provisioning Playbook
# ============================================================================
# Purpose: Complete server infrastructure setup
# Run once: When setting up a new server
# Application deployment: Use GitHub Actions workflows
# ============================================================================

- name: Provision Django servers
  hosts: all
  become: yes

  pre_tasks:
    - name: Set environment facts
      set_fact:
        deploy_env: "{{ deploy_env | default('production') }}"

    - name: Display provisioning information
      debug:
        msg: |
          ========================================
          Server Infrastructure Provisioning
          ========================================
          Server: {{ inventory_hostname }}
          Environment: {{ deploy_env }}
          Cloud Provider: {{ cloud_provider | default('generic') }}
          ========================================

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Upgrade all packages (production only)
      apt:
        upgrade: dist
        autoremove: yes
      when:
        - ansible_os_family == "Debian"
        - deploy_env == "production"

  roles:
    - role: common
      tags: [common, security]

    - role: docker
      tags: [docker]

    - role: nginx
      when: setup_nginx | default(true)
      tags: [nginx]

    - role: ssl
      when: setup_ssl | default(true)
      tags: [ssl]

    - role: aws_security
      tags: [aws, security, cloud]
      when: cloud_provider == 'aws'

    - role: failover
      tags: [failover, ha]
      when: failover_ip is defined

    - role: monitoring
      tags: [monitoring]
      when: enable_monitoring | default(true)

    - role: github_actions
      tags: [github, deployment, ci]
      when: setup_github_actions | default(true)

  post_tasks:
    - name: Create data directories for Docker volumes
      file:
        path: "{{ app_dir | default('/home/' + app_user + '/projects/django_app') }}/data/{{ item }}"
        state: directory
        owner: "{{ app_user | default('appuser') }}"
        group: django
        mode: '0775'
      loop:
        - dev
        - prod
      tags: [app-setup]

    - name: Set SGID bit on data directories
      file:
        path: "{{ app_dir | default('/home/' + app_user + '/projects/django_app') }}/data/{{ item }}"
        state: directory
        mode: g+s
      loop:
        - dev
        - prod
      tags: [app-setup]

    - name: Verify Docker is running
      systemd:
        name: docker
        state: started
      check_mode: yes
      register: docker_status

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Display provisioning summary
      debug:
        msg: |
          ========================================
          ✅ Server Provisioning Complete!
          ========================================
          Environment: {{ deploy_env }}
          Hostname: {{ inventory_hostname }}
          Docker: {{ 'Running' if docker_status.status.ActiveState == 'active' else 'Not Running' }}
          Firewall: Enabled (UFW)
          SSL: {{ 'Configured' if domain_name is defined else 'Not Configured' }}
          Monitoring: {{ 'Enabled' if enable_monitoring | default(true) else 'Disabled' }}
          Reboot Required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}

          Next Steps:
          ──────────────────────────────────────
          1. Verify GitHub Secrets are configured
          2. Push to trigger deployment via GitHub Actions
          3. Or deploy manually with scripts/deploy.sh

          Documentation: docs/deployment.md
          ========================================

    - name: Reboot server if required and authorized
      reboot:
        msg: "Rebooting to apply updates"
        reboot_timeout: 300
      when:
        - reboot_required.stat.exists
        - auto_reboot | default(false)
