---
- name: Configure GitHub Actions deployment access
  block:
    - name: Set essential variables
      set_fact:
        app_user: "{{ app_user | default(lookup('env', 'APP_USER') | default(ansible_user | default('ubuntu'))) }}"
        project_name: "{{ project_name | default('django_app') }}"

    - name: Set app_dir with defaults
      set_fact:
        app_dir: "{{ app_dir | default('/home/' + app_user + '/projects/' + project_name) }}"

    - name: Get GitHub Actions SSH key from environment
      set_fact:
        github_actions_ssh_key: "{{ github_actions_ssh_key | default(lookup('env', 'GITHUB_ACTIONS_SSH_KEY')) }}"
      when: github_actions_ssh_key is not defined

    - name: Validate SSH key is provided
      fail:
        msg: |
          ========================================
          ⚠️  GitHub Actions SSH Key Required
          ========================================

          Please provide the SSH public key via one of:

          1. Environment variable:
             export GITHUB_ACTIONS_SSH_KEY="ssh-ed25519 AAAA..."

          2. Ansible variable:
             -e "github_actions_ssh_key=ssh-ed25519 AAAA..."

          To generate a new SSH key:
             ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/github_actions

          Then add the private key to GitHub Secrets:
             PROD_SSH_KEY: (contents of ~/.ssh/github_actions)

          Documentation: docs/github-actions-setup.md
          ========================================
      when: github_actions_ssh_key is not defined or github_actions_ssh_key | length == 0

    - name: Add GitHub Actions SSH public key to app user authorized_keys
      authorized_key:
        user: "{{ app_user }}"
        key: "{{ github_actions_ssh_key }}"
        state: present
        comment: "GitHub Actions deployment key"

    - name: Add GitHub Actions SSH public key to ansible user authorized_keys
      authorized_key:
        user: "{{ ansible_user }}"
        key: "{{ github_actions_ssh_key }}"
        state: present
        comment: "GitHub Actions deployment key"

    - name: Ensure application directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    - name: Create .env template for application
      template:
        src: env.template.j2
        dest: "{{ app_dir }}/.env.template"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
      when: create_env_template | default(true)

    - name: Check if .env file exists
      stat:
        path: "{{ app_dir }}/.env"
      register: env_file_check

    - name: Create .env file from template if it doesn't exist
      copy:
        src: "{{ app_dir }}/.env.template"
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0600'
        remote_src: yes
      when:
        - not env_file_check.stat.exists
        - create_env_template | default(true)

    - name: Display GitHub Actions setup completion
      debug:
        msg: |
          ========================================
          ✅ GitHub Actions Setup Complete!
          ========================================

          Server Details:
          ──────────────────────────────────────
          Host: {{ inventory_hostname }}
          User: {{ app_user }}
          App Directory: {{ app_dir }}

          GitHub Secrets Required:
          ──────────────────────────────────────
          Repository: {{ lookup('env', 'GITHUB_REPOSITORY') | default('YOUR_USERNAME/YOUR_REPO') }}
          Settings: https://github.com/{{ lookup('env', 'GITHUB_REPOSITORY') | default('YOUR_USERNAME/YOUR_REPO') }}/settings/secrets/actions

          Add these secrets:
          - PROD_HOST = {{ inventory_hostname }}
          - PROD_SSH_KEY = (private key content)

          For other environments:
          - DEV_HOST / DEV_SSH_KEY
          - STAGING_HOST / STAGING_SSH_KEY

          Next Steps:
          ──────────────────────────────────────
          1. Configure .env file: ssh {{ app_user }}@{{ inventory_hostname }} nano {{ app_dir }}/.env
          2. Push to GitHub to trigger deployment

          Documentation: docs/github-actions-setup.md
          ========================================
