---
- name: Provision Django servers
  hosts: all
  become: yes

  pre_tasks:
    - name: Set environment facts
      set_fact:
        deploy_env: "{{ deploy_env | default('production') }}"

    - name: Display provisioning information
      debug:
        msg: |
          Starting server provisioning
          Environment: {{ deploy_env }}
          Cloud Provider: {{ cloud_provider }}
          Server: {{ inventory_hostname }}

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Upgrade all packages (production only)
      apt:
        upgrade: dist
        autoremove: yes
      when:
        - ansible_os_family == "Debian"
        - deploy_env == "production"

  roles:
    - role: common
      tags: [common, security]

    - role: docker
      tags: [docker]

    - role: aws_security
      tags: [aws, security, cloud]
      when: cloud_provider == 'aws'

    - role: failover
      tags: [failover, ha]
      when: failover_ip is defined

    - role: monitoring
      tags: [monitoring]
      when: enable_monitoring | default(true)

    - role: github_actions
      tags: [github, deployment, ci]
      when: setup_github_actions | default(true)

    - role: django
      tags: [django, app]
      when: deploy_app | default(false)

  post_tasks:
    - name: Verify Docker is running
      systemd:
        name: docker
        state: started
      check_mode: yes
      register: docker_status

    - name: Display provisioning summary
      debug:
        msg: |
          ========================================
          Server Provisioning Complete
          ========================================
          Environment: {{ deploy_env }}
          Hostname: {{ inventory_hostname }}
          Docker: {{ 'Running' if docker_status.status.ActiveState == 'active' else 'Not Running' }}
          Firewall: Enabled (UFW)
          SSL: {{ 'Configured' if domain_name is defined else 'Not Configured' }}
          Monitoring: {{ 'Enabled' if enable_monitoring | default(true) else 'Disabled' }}
          ========================================

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Notify if reboot is needed
      debug:
        msg: "WARNING: System reboot is required to complete kernel updates"
      when: reboot_required.stat.exists

    - name: Reboot server if required and authorized
      reboot:
        msg: "Rebooting to apply updates"
        reboot_timeout: 300
      when:
        - reboot_required.stat.exists
        - auto_reboot | default(false)
